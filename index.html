<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å‚·å£è¨˜éŒ„ç³»çµ±</title>
  <style>
    body {
      padding: 24px;
      font-family: "Arial", sans-serif;
      background: #f4f6f8;
      font-size: 16px;
      color: #333;
    }

    .top-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 20px;
        align-items: center;
      }

    label {
      font-weight: bold;
      margin-top: 16px;
      display: block;
    }
    .json-import {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .json-import label {
      display: inline-block;
      margin-top: 0;
      min-width: 130px;
      font-weight: bold;
    }

    .json-import input {
      width: auto; 
      min-width: 400px;
      margin-top: 0;
    }

    .other-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto; /* â¬…ï¸ é‡é»ï¼šå¾€å³æ¨ */
      flex-wrap: wrap;
    }
    
    input, select, textarea {
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
    }

    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background-color: #a19171;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #917f61;
    }

    .buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .entry {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 20px;
      border-left: 4px solid #a19171;
    }

    .entry img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 12px 0;
    }

    .entry:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    h1, h2 {
      color: #4a4a4a;
      font-size: 24px;
      margin-bottom: 12px;
    }

    hr {
      border: none;
      height: 1px;
      background-color: #ddd;
      margin: 24px 0;
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
        font-size: 18px;
      }

      .buttons {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        margin: 12px 0;
      }

      button {
        width: 100%;
        font-size: 18px;
      }

      input, select, textarea {
        font-size: 18px;
      }

      h1, h2 {
        font-size: 20px;
      }
    }

    /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ï¼šæœ€å¤§å¯¬åº¦ 768px æ™‚å¥—ç”¨ */
    @media (max-width: 768px) {
      .export-buttons {
        text-align: left;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .export-buttons button {
        width: auto; /* å¯åŠ é€™è¡Œè®“æŒ‰éˆ•å¯¬åº¦ä¸æœƒæ’æ»¿ */
      }
    }
  </style>
</head>
<body>
  <h1>å‚·å£ç´€éŒ„ç¶²ç«™</h1>

  <label for="upload">ä¸Šå‚³å‚·å£åœ–ç‰‡ï¼š</label>
  <input type="file" id="upload" accept="image/*" />
  <p id="previewLabel" style="display:none;">åœ–ç‰‡é è¦½ï¼š</p>
  <img id="preview" src="" width="300" style="display:none;" />
  
<div hidden>
  <label>å‚·å£é¢ç©ï¼ˆå¹³æ–¹å…¬åˆ†ï¼‰ï¼š</label>
  <input type="text" id="area" readonly />
</div>

  <label for="length">å‚·å£é•·åº¦ï¼ˆå…¬åˆ†ï¼‰ï¼š</label>
  <input type="number" id="length" placeholder="ä¾‹å¦‚ï¼š5.0" step="0.1" min="0" />

  <label for="width">å‚·å£å¯¬åº¦ï¼ˆå…¬åˆ†ï¼‰ï¼š</label>
  <input type="number" id="width" placeholder="ä¾‹å¦‚ï¼š3.0" step="0.1" min="0" />

  <label for="depth">å‚·å£æ·±åº¦ï¼ˆå…¬åˆ†ï¼‰ï¼š</label>
  <input type="number" id="depth" placeholder="ä¾‹å¦‚ï¼š1.2" step="0.1" min="0" />

  <label for="type">å‚·å£é¡å‹ï¼š</label>
  <select id="type">
    <option value="">è«‹é¸æ“‡</option>
    <option value="å‰²å‚·">å‰²å‚·</option>
    <option value="ç‡™å‚·">ç‡™å‚·</option>
    <option value="å£“ç˜¡">å£“ç˜¡</option>
    <option value="æ“¦å‚·">æ“¦å‚·</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>

  <label for="dressing">æ›è—¥æ–¹å¼ï¼š</label>
  <input type="text" id="dressing" placeholder="ä¾‹å¦‚ï¼šæ¿•æ€§æ•·æ–™" />

  <label for="pain">ç–¼ç—›ç­‰ç´šï¼ˆ0â€“10ï¼‰ï¼š</label>
  <input type="number" id="pain" min="0" max="10" step="1" />

  <label for="note">å‚™è¨»ï¼š</label>
  <textarea id="note" rows="3" placeholder="ä¾‹å¦‚ï¼šé¡è‰²ã€å½¢ç‹€ã€æ»²æ¶²" style="margin-top: 16px;"></textarea>

  <div class="buttons">
    <button id="saveRecord">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
  </div>
  <hr />

  <h2>ğŸ“‹ å‚·å£ç´€éŒ„çµæœ</h2>
  <p id="recordCount"></p>
  <div class="top-controls">
    <div class="json-import">
      <label for="importFile">åŒ¯å…¥ JSON å‚™ä»½ï¼š</label>
      <input type="file" id="importFile" accept=".json">
      <button onclick="importBackup()">ğŸ“¤ åŒ¯å…¥</button>
    </div>

    <div class="other-controls">
      <button onclick="downloadAll()">ğŸ“¥ å‚™ä»½æ‰€æœ‰ç´€éŒ„</button>
      <button onclick="clearAll()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
      <button onclick="showStorageSize()">ğŸ“¦ æŸ¥çœ‹ä½¿ç”¨å®¹é‡</button>
    </div>
  </div>

  <div id="result"></div>

  <script>
    function resizeImage(file, maxWidth, maxHeight, callback) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
          callback(dataUrl);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function calculateArea() {
      const length = parseFloat(document.getElementById("length").value);
      const width = parseFloat(document.getElementById("width").value);
      const areaInput = document.getElementById("area");
      if (!isNaN(length) && !isNaN(width)) {
        areaInput.value = (length * width).toFixed(2);
      } else {
        areaInput.value = "";
      }
    }

    document.getElementById("length").addEventListener("input", calculateArea);
    document.getElementById("width").addEventListener("input", calculateArea);

    const upload = document.getElementById("upload");
    const preview = document.getElementById("preview");
    const previewLabel = document.getElementById("previewLabel");
    const saveButton = document.getElementById("saveRecord");
    const resultDiv = document.getElementById("result");
    let currentImageBase64 = "";

    upload.addEventListener("change", function () {
      const file = upload.files[0];
      if (file) {
        resizeImage(file, 300, 300, function (resizedDataUrl) {
          currentImageBase64 = resizedDataUrl;
          preview.src = currentImageBase64;
          preview.style.display = "block";
          previewLabel.style.display = "block";
        });
      } else {
        currentImageBase64 = "";
        preview.src = "";
        preview.style.display = "none";
        previewLabel.style.display = "none";
      }
    });

    function addRecordToDOM(record, index) {
      const entry = document.createElement("div");
      entry.className = "entry";
      entry.innerHTML = `
        ğŸ•’ <strong>æ™‚é–“</strong>ï¼š${record.time}<br>
        ${record.image ? `<img src="${record.image}" alt="å‚·å£åœ–ç‰‡" />` : ""}
        <div class="buttons">
          <button class="btn" onclick="downloadImage(${index})">ä¸‹è¼‰åœ–ç‰‡</button>
          <button class="btn" onclick="deleteRecord(${index})">åˆªé™¤</button>
        </div>
        ğŸ”¹ <strong>é•·åº¦</strong>ï¼š${record.length} å…¬åˆ†ï¼Œ
        <strong>å¯¬åº¦</strong>ï¼š${record.width} å…¬åˆ†ï¼Œ
        <strong>æ·±åº¦</strong>ï¼š${record.depth} å…¬åˆ†ï¼Œ
        <strong>é¢ç©</strong>ï¼š${record.area} å¹³æ–¹å…¬åˆ†ï¼Œ
        <strong>é¡å‹</strong>ï¼š${record.type}<br>
        ğŸ©¹ <strong>æ›è—¥æ–¹å¼</strong>ï¼š${record.dressing}<br>
        ğŸ˜– <strong>ç–¼ç—›ç­‰ç´š</strong>ï¼š${record.pain} / 10<br>
        ğŸ“ <strong>å‚™è¨»</strong>ï¼š${record.note}
        <hr>
      `;
      resultDiv.appendChild(entry);
    }

    function loadRecords() {
      resultDiv.innerHTML = "";
      const records = JSON.parse(localStorage.getItem("woundRecords") || "[]");
      document.getElementById("recordCount").innerText = `ç›®å‰å…±æœ‰ ${records.length} ç­†ç´€éŒ„`;
      records.forEach((record, index) => addRecordToDOM(record, index));
    }

    saveButton.addEventListener("click", () => {
      const length = document.getElementById("length").value.trim();
      const width = document.getElementById("width").value.trim();
      const depth = document.getElementById("depth").value.trim();
      const type = document.getElementById("type").value.trim();
      const dressing = document.getElementById("dressing").value.trim();
      const pain = document.getElementById("pain").value.trim();
      const note = document.getElementById("note").value.trim();
      const area = document.getElementById("area").value.trim();

      if (!length || !width || !depth || !type) {
        alert("è«‹å®Œæ•´å¡«å¯«å‚·å£é•·ã€å¯¬ã€æ·±åº¦èˆ‡é¡å‹ï¼");
        return;
      }

      const record = {
        time: new Date().toLocaleString(),
        image: currentImageBase64,
        length,
        width,
        depth,
        type,
        area,
        note,
        dressing,
        pain,
      };

      const records = JSON.parse(localStorage.getItem("woundRecords") || "[]");
      records.unshift(record);
      if (records.length >= 10) {
        records.pop();
      }
      localStorage.setItem("woundRecords", JSON.stringify(records));
      loadRecords();

      document.getElementById("length").value = "";
      document.getElementById("width").value = "";
      document.getElementById("depth").value = "";
      document.getElementById("type").value = "";
      document.getElementById("note").value = "";
      document.getElementById("dressing").value = "";
      document.getElementById("pain").value = "";
      document.getElementById("area").value = ""; 
      upload.value = "";
      currentImageBase64 = "";
      preview.src = "";
      preview.style.display = "none";
      previewLabel.style.display = "none";
    });

    function deleteRecord(index) {
      const records = JSON.parse(localStorage.getItem("woundRecords") || "[]");
      if (index >= 0 && index < records.length) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†ç´€éŒ„å—ï¼Ÿ")) {
          records.splice(index, 1);
          localStorage.setItem("woundRecords", JSON.stringify(records));
          loadRecords();
        }
      }
    }

    function downloadImage(index) {
      const records = JSON.parse(localStorage.getItem("woundRecords") || "[]");
      if (index >= 0 && index < records.length) {
        const record = records[index];
        if (!record.image) {
          alert("æ­¤ç´€éŒ„æ²’æœ‰åœ–ç‰‡å¯ä»¥ä¸‹è¼‰");
          return;
        }
        const a = document.createElement("a");
        a.href = record.image;
        a.download = `wound_${record.time.replace(/[^\d]/g, "")}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }

    window.deleteRecord = deleteRecord;
    window.downloadImage = downloadImage;

    loadRecords();

    function clearAll() {
      if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
        localStorage.removeItem("woundRecords");
        loadRecords();
      }
    }

    function downloadAll() {
      const records = localStorage.getItem("woundRecords") || "[]";
      const blob = new Blob([records], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "wound_records_backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function showStorageSize() {
      const all = JSON.stringify(localStorage);
      const kb = (new Blob([all]).size / 1024).toFixed(2);
      alert("ç›®å‰ localStorage ä½¿ç”¨å®¹é‡ç´„ç‚º " + kb + " KB");
    }

    function importBackup() {
      const fileInput = document.getElementById("importFile");
      const file = fileInput.files[0];
      if (!file) {
        alert("è«‹å…ˆé¸æ“‡è¦åŒ¯å…¥çš„ JSON æª”æ¡ˆï¼");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const importedData = JSON.parse(event.target.result);
          if (!Array.isArray(importedData)) throw new Error("æ ¼å¼éŒ¯èª¤");

                   if (!importedData.every(item =>
            typeof item.time === "string" &&
            typeof item.length === "string" &&
            typeof item.width === "string" &&
            typeof item.depth === "string"
          )) throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤");

          localStorage.setItem("woundRecords", JSON.stringify(importedData));
          loadRecords();
          alert("åŒ¯å…¥æˆåŠŸï¼");
        } catch (e) {
          alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼");
        }
      };
      reader.readAsText(file);
    }

  </script>
</body>
</html>
